/*
 * File: UserChecker.js
 * Project: react-blog
 * Created: Wednesday, August 9th 2023, 5:31:54 pm
 * Last Modified: Thursday, August 10th 2023, 5:16:20 am
 * Copyright © 2022 AMDE Agência
 */

import {useEffect, useContext} from 'react'
import useFetch from 'hooks/useFetch'
import useLocalStorage from 'hooks/useLocalStorage'
import {CurrentUserContext} from 'contexts/currentUser'

const UserChecker = ({children}) => {
  const [, setCurrentUserState] = useContext(CurrentUserContext)
  const [{response}, doFetch] = useFetch('/user')
  const [token] = useLocalStorage('token')

  useEffect(() => {
    if (!token) {
      setCurrentUserState((state) => ({
        ...state,
        isLoggedIn: false,
      }))

      return
    }

    doFetch()
    setCurrentUserState((state) => ({
      ...state,
      isLoading: true,
    }))
  }, [doFetch, setCurrentUserState, token])

  useEffect(() => {
    if (!response) {
      return
    }

    setCurrentUserState((state) => ({
      ...state,
      isLoggedIn: false,
      isLoading: false,
      currentUser: response.user,
    }))
  }, [response])

  return children
}

export default UserChecker
